<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç»†èƒå…‹éš†è‡ªåŠ¨è®¡æ•°å·¥å…· (çº¯å‰ç«¯ç‰ˆ)</title>
    <script async src="https://docs.opencv.org/4.x/opencv.js" type="text/javascript"></script>
    <style>
        body { font-family: sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: #f4f7f6; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        canvas { max-width: 100%; height: auto; border: 1px solid #ddd; margin-top: 10px; }
        .res-info { background: #e7f3ff; padding: 15px; border-radius: 5px; margin-top: 10px; font-weight: bold; color: #0056b3; }
        .loading { color: red; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ§« ç»†èƒå…‹éš†è‡ªåŠ¨è®¡æ•°å·¥å…·</h2>
    <p id="status" class="loading">æ­£åœ¨åŠ è½½ OpenCV.js (çº¦ 10MB)ï¼Œè¯·ç¨å€™...</p>
    
    <div class="controls">
        <div>
            <label>1. é€‰æ‹©å›¾ç‰‡ï¼š</label><br>
            <input type="file" id="fileInput" accept="image/*">
        </div>
        <div>
            <label>2. è°ƒæ•´é˜ˆå€¼ (çµæ•åº¦)ï¼š</label>
            <input type="range" id="thresholdRange" min="0" max="255" value="120">
            <span id="threshVal">120</span>
        </div>
    </div>

    <div class="res-info" id="resultText">å¾…ä¸Šä¼ å›¾ç‰‡...</div>

    <div style="display: flex; gap: 10px;">
        <div>
            <h4>åŸå§‹å›¾ç‰‡</h4>
            <canvas id="canvasInput"></canvas>
        </div>
        <div>
            <h4>å¤„ç†ç»“æœ (è¯†åˆ«ç»“æœ)</h4>
            <canvas id="canvasOutput"></canvas>
        </div>
    </div>
</div>

<script type="text/javascript">
let imgElement = document.getElementById('canvasInput');
let inputElement = document.getElementById('fileInput');
let threshSlider = document.getElementById('thresholdRange');

// å½“OpenCVå‡†å¤‡å°±ç»ª
var cvReady = false;
function onOpenCvReady() {
    document.getElementById('status').innerHTML = "âœ… OpenCV.js å·²å°±ç»ªï¼Œè¯·ä¸Šä¼ ç…§ç‰‡";
    document.getElementById('status').style.color = "green";
    cvReady = true;
}

// å›¾ç‰‡åŠ è½½å¤„ç†
inputElement.addEventListener('change', (e) => {
    let reader = new FileReader();
    reader.onload = (event) => {
        let img = new Image();
        img.onload = () => {
            let canvas = document.getElementById('canvasInput');
            canvas.width = img.width;
            canvas.height = img.height;
            let ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            processImage();
        };
        img.src = event.target.result;
    };
    reader.readAsDataURL(e.target.files[0]);
}, false);

threshSlider.oninput = function() {
    document.getElementById('threshVal').innerHTML = this.value;
    if(cvReady) processImage();
}

// æ ¸å¿ƒå¤„ç†ç®—æ³•
function processImage() {
    let src = cv.imread('canvasInput');
    let dst = new cv.Mat();
    let gray = new cv.Mat();
    
    // 1. ç°åº¦åŒ–
    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
    
    // 2. é«˜æ–¯æ»¤æ³¢å»å™ª
    let ksize = new cv.Size(5, 5);
    cv.GaussianBlur(gray, gray, ksize, 0, 0, cv.BORDER_DEFAULT);
    
    // 3. é˜ˆå€¼åˆ†å‰² (è¿™é‡Œå‡è®¾èƒŒæ™¯äº®ç»†èƒæš—ï¼Œæ‰€ä»¥ç”¨ INV)
    let thresh = parseInt(threshSlider.value);
    cv.threshold(gray, gray, thresh, 255, cv.THRESH_BINARY_INV);
    
    // 4. å½¢æ€å­¦å¼€è¿ç®—ï¼šå»æ‰å™ªç‚¹
    let M = cv.Mat.ones(3, 3, cv.CV_8U);
    cv.morphologyEx(gray, gray, cv.MORPH_OPEN, M);
    
    // 5. æŸ¥æ‰¾è½®å»“
    let contours = new cv.MatVector();
    let hierarchy = new cv.Mat();
    cv.findContours(gray, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
    
    let count = 0;
    let minArea = 50; // è¿‡æ»¤æ‰å¤ªå°çš„æ‚è´¨

    for (let i = 0; i < contours.size(); ++i) {
        let cnt = contours.get(i);
        let area = cv.contourArea(cnt);
        if (area > minArea) {
            count++;
            // åœ¨åŸå›¾ç»˜åˆ¶ç»¿è‰²è½®å»“
            let color = new cv.Scalar(0, 255, 0, 255);
            cv.drawContours(src, contours, i, color, 2, cv.LINE_8, hierarchy, 0);
        }
    }

    cv.imshow('canvasOutput', src);
    document.getElementById('resultText').innerHTML = `æ£€æµ‹å®Œæˆï¼è¯†åˆ«åˆ°å…‹éš†æ•°ï¼š${count}`;

    // é‡Šæ”¾å†…å­˜
    src.delete(); dst.delete(); gray.delete(); M.delete(); contours.delete(); hierarchy.delete();
}

// è½®è¯¢æ£€æŸ¥OpenCVåŠ è½½
let checkCv = setInterval(() => {
    if (typeof cv !== 'undefined' && cv.getBuildInformation) {
        onOpenCvReady();
        clearInterval(checkCv);
    }
}, 300);
</script>

</body>
</html>
