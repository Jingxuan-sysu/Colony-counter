<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ColonyCounter AI - çº¯å‰ç«¯ç»†èƒå…‹éš†è®¡æ•°</title>
    <script async src="https://docs.opencv.org/4.5.4/opencv.js" type="text/javascript"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; color: var(--primary); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        header { text-align: center; border-bottom: 2px solid #eee; margin-bottom: 20px; padding-bottom: 10px; }
        
        .upload-section { border: 2px dashed #ccc; padding: 40px; text-align: center; border-radius: 10px; transition: 0.3s; cursor: pointer; background: #fafafa; }
        .upload-section:hover { border-color: var(--accent); background: #f1f9ff; }
        #fileInput { display: none; }

        .dashboard { display: grid; grid-template-columns: 300px 1fr; gap: 30px; margin-top: 20px; }
        .controls { background: #f8f9fa; padding: 20px; border-radius: 8px; height: fit-content; }
        .control-group { margin-bottom: 20px; }
        label { display: block; font-size: 0.9rem; font-weight: bold; margin-bottom: 8px; }
        input[type="range"] { width: 100%; cursor: pointer; }
        
        .display-area { display: flex; flex-direction: column; gap: 20px; }
        .canvas-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        canvas { width: 100%; border-radius: 4px; background: #000; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        
        .stats-card { background: var(--primary); color: white; padding: 15px; border-radius: 8px; text-align: center; font-size: 1.2rem; }
        #status { font-weight: bold; color: #e67e22; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ğŸ”¬ ç»†èƒå…‹éš†è‡ªåŠ¨è®¡æ•°ç³»ç»Ÿ</h1>
        <p id="status">æ­£åœ¨åŠ è½½æ ¸å¿ƒç®—æ³•åº“ï¼Œè¯·ç¨å€™...</p>
    </header>

    <div class="upload-section" onclick="document.getElementById('fileInput').click()">
        <h3>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„ä¸Šä¼ </h3>
        <p>æ”¯æŒ JPG, PNG æ ¼å¼çš„åŸ¹å…»çš¿ç…§ç‰‡</p>
        <input type="file" id="fileInput" accept="image/*">
    </div>

    <div class="dashboard">
        <div class="controls">
            <div class="stats-card">
                è®¡æ•°ç»“æœï¼š<span id="counter">0</span>
            </div>
            <hr>
            <div class="control-group">
                <label>è¯†åˆ«çµæ•åº¦ (é˜ˆå€¼): <span id="v_thresh">120</span></label>
                <input type="range" id="threshold" min="0" max="255" value="120">
            </div>
            <div class="control-group">
                <label>è¿‡æ»¤å¾®å°æ‚è´¨ (é¢ç§¯): <span id="v_area">50</span></label>
                <input type="range" id="minArea" min="5" max="1000" value="50">
            </div>
            <p style="font-size: 0.8rem; color: #666;">* è°ƒæ•´æ»‘å—åç»“æœä¼šè‡ªåŠ¨æ›´æ–°</p>
            <button onclick="downloadResult()" style="width: 100%; padding: 10px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer;">ä¸‹è½½ç»Ÿè®¡å›¾</button>
        </div>

        <div class="display-area">
            <div class="canvas-container">
                <div>
                    <label>åŸå§‹è¾“å…¥</label>
                    <canvas id="canvasInput"></canvas>
                </div>
                <div>
                    <label>è¯†åˆ«ç»“æœ (ç»¿è‰²æ ‡è®°)</label>
                    <canvas id="canvasOutput"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let srcImg = null;

// 1. OpenCV åŠ è½½çŠ¶æ€ç›‘æ§
function onOpenCvReady() {
    document.getElementById('status').innerText = "âœ… ç³»ç»Ÿå°±ç»ªï¼Œè¯·ä¸Šä¼ å®éªŒå›¾ç‰‡";
    document.getElementById('status').style.color = "#27ae60";
}

// 2. å¯¼å…¥å›¾ç‰‡åŠŸèƒ½å®ç°
const fileInput = document.getElementById('fileInput');
fileInput.onchange = (e) => {
    if (e.target.files.length === 0) return;
    const url = URL.createObjectURL(e.target.files[0]);
    const img = new Image();
    img.onload = () => {
        const ctx = document.getElementById('canvasInput').getContext('2d');
        document.getElementById('canvasInput').width = img.width;
        document.getElementById('canvasInput').height = img.height;
        ctx.drawImage(img, 0, 0);
        
        // å°†å›¾ç‰‡è¯»å…¥ OpenCV å†…å­˜
        if (srcImg) srcImg.delete();
        srcImg = cv.imread('canvasInput');
        processImage(); // å¯¼å…¥åç«‹å³åˆ†æ
    };
    img.src = url;
};

// 3. å®æ—¶åˆ†æç®—æ³•
function processImage() {
    if (!srcImg) return;

    let dst = srcImg.clone();
    let gray = new cv.Mat();
    let thresh = new cv.Mat();
    let contours = new cv.MatVector();
    let hierarchy = new cv.Mat();

    // é¢„å¤„ç†
    cv.cvtColor(dst, gray, cv.COLOR_RGBA2GRAY);
    cv.GaussianBlur(gray, gray, new cv.Size(5, 5), 0);
    
    // è·å–æ»‘å—å‚æ•°
    const t_val = parseInt(document.getElementById('threshold').value);
    const a_val = parseInt(document.getElementById('minArea').value);
    document.getElementById('v_thresh').innerText = t_val;
    document.getElementById('v_area').innerText = a_val;

    // äºŒå€¼åŒ– (å‡è®¾èƒŒæ™¯äº®ç»†èƒæš—)
    cv.threshold(gray, thresh, t_val, 255, cv.THRESH_BINARY_INV);
    
    // å½¢æ€å­¦å»å™ª
    let M = cv.Mat.ones(3, 3, cv.CV_8U);
    cv.morphologyEx(thresh, thresh, cv.MORPH_OPEN, M);

    // å¯»æ‰¾å…‹éš†è½®å»“
    cv.findContours(thresh, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

    let count = 0;
    for (let i = 0; i < contours.size(); ++i) {
        let cnt = contours.get(i);
        let area = cv.contourArea(cnt);
        if (area > a_val) {
            count++;
            let color = new cv.Scalar(0, 255, 0, 255);
            cv.drawContours(dst, contours, i, color, 3);
            
            // ç»˜åˆ¶æ•°å­—ç¼–å·
            let rect = cv.boundingRect(cnt);
            let point = new cv.Point(rect.x, rect.y);
            cv.putText(dst, count.toString(), point, cv.FONT_HERSHEY_SIMPLEX, 0.8, [255, 0, 0, 255], 2);
        }
    }

    cv.imshow('canvasOutput', dst);
    document.getElementById('counter').innerText = count;

    // å†…å­˜æ¸…ç†
    gray.delete(); thresh.delete(); contours.delete(); hierarchy.delete(); dst.delete(); M.delete();
}

// 4. ç›‘å¬æ»‘å—å®ç°å®æ—¶åé¦ˆ
document.getElementById('threshold').oninput = processImage;
document.getElementById('minArea').oninput = processImage;

// 5. ä¸‹è½½åŠŸèƒ½
function downloadResult() {
    const canvas = document.getElementById('canvasOutput');
    const link = document.createElement('a');
    link.download = 'colony-count-result.png';
    link.href = canvas.toDataURL();
    link.click();
}

// è½®è¯¢æ£€æµ‹ OpenCV æ˜¯å¦åŠ è½½å®Œæˆ
var Module = { onRuntimeInitialized: onOpenCvReady };
</script>

</body>
</html>
