<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>6å­”æ¿å…‹éš†è®¡æ•° - å¢å¼ºè¯†åˆ«ç‰ˆ</title>
    <style>
        :root { --accent: #27ae60; --primary: #2c3e50; }
        body { font-family: system-ui, -apple-system, sans-serif; background: #f4f7f6; margin: 0; padding: 20px; color: var(--primary); }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); }
        .main-layout { display: grid; grid-template-columns: 320px 1fr; gap: 20px; margin-top: 20px; }
        .sidebar { background: #f8f9fa; padding: 20px; border-radius: 10px; border: 1px solid #e1e4e8; }
        .canvas-wrapper { position: relative; border: 2px solid #333; cursor: crosshair; background: #222; overflow: hidden; border-radius: 8px; }
        canvas { display: block; max-width: 100%; height: auto; }
        .btn { width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-primary { background: #3498db; color: white; }
        .btn-switch { background: #e67e22; color: white; }
        .label { font-weight: bold; font-size: 0.85em; display: block; margin: 15px 0 5px; color: #555; }
        .stats { background: var(--primary); color: white; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 15px; }
        #status-tag { position: fixed; top: 10px; right: 10px; padding: 5px 15px; border-radius: 20px; font-size: 0.8em; background: #eee; z-index: 999; }
    </style>
</head>
<body>

<div id="status-tag">â³ åº“åŠ è½½ä¸­...</div>

<div class="container">
    <div style="text-align:center">
        <h2>ğŸ”¬ é«˜çµæ•åº¦ç»†èƒå…‹éš†è®¡æ•°å™¨</h2>
        <p>æ‰‹åŠ¨å®šå­”åï¼Œå¦‚è¯†åˆ«ä¸åˆ°è¯·åˆ‡æ¢â€œåº•è‰²æ¨¡å¼â€æˆ–è°ƒæ•´â€œçµæ•åº¦â€</p>
    </div>

    <div class="main-layout">
        <div class="sidebar">
            <div class="stats">
                <small>å½“å‰æ£€æµ‹è®¡æ•°</small>
                <div style="font-size: 2.8rem; font-weight: bold;" id="totalCount">0</div>
            </div>

            <input type="file" id="fileInput" accept="image/*" style="display:none">
            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">1. ä¸Šä¼ å®éªŒå›¾ç‰‡</button>
            <button class="btn" style="background:#95a5a6; color:white;" onclick="resetPoints()">é‡é€‰åœ†å¿ƒç‚¹</button>
            
            <hr>
            
            <button class="btn btn-switch" onclick="toggleMode()">æ¨¡å¼åˆ‡æ¢ï¼š<span id="modeName">æµ…è‰²åº•-æ·±è‰²é›†è½</span></button>
            
            <span class="label">è¯†åˆ«çµæ•åº¦ (é˜ˆå€¼): <span id="v_thresh">120</span></span>
            <input type="range" id="threshold" min="0" max="255" value="120">

            <span class="label">å­”å¾„åŠå¾„: <span id="v_radius">200</span></span>
            <input type="range" id="radiusRange" min="50" max="1200" value="200">

            <span class="label">æœ€å°é›†è½é¢ç§¯ (åƒç´ ): <span id="v_area">20</span></span>
            <input type="range" id="minArea" min="2" max="500" value="20">

            <p style="font-size: 0.75rem; color: #666; margin-top: 20px;">
                ğŸ’¡ <b>æŠ€å·§ï¼š</b><br>
                - å…ˆç‚¹åœ†å¿ƒï¼Œçº¢åœˆå‡ºç°åå†è°ƒå‚ã€‚<br>
                - è°ƒæ•´â€œå­”å¾„åŠå¾„â€ä½¿çº¢åœˆç•¥å°äºå­”å†…å¾„ã€‚
            </p>
        </div>

        <div class="display-area">
            <div class="canvas-wrapper">
                <canvas id="canvasMain"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
let srcMat = null;
let points = [];
let isDarkColony = true; // é»˜è®¤æ·±è‰²é›†è½ï¼ˆå¦‚ç»“æ™¶ç´«ï¼‰

const opencvUrl = 'https://docs.opencv.org/4.5.4/opencv.js';

function toggleMode() {
    isDarkColony = !isDarkColony;
    document.getElementById('modeName').innerText = isDarkColony ? "æµ…è‰²åº•-æ·±è‰²é›†è½" : "æ·±è‰²åº•-æµ…è‰²é›†è½";
    processImage();
}

// åŠ è½½ OpenCV
const loadCV = () => {
    const script = document.createElement('script');
    script.src = opencvUrl;
    script.async = true;
    script.onload = () => {
        const check = setInterval(() => {
            if (typeof cv !== 'undefined' && cv.Mat) {
                document.getElementById('status-tag').innerText = "âœ… ç®—æ³•åº“å°±ç»ª";
                document.getElementById('status-tag').style.background = "#d4edda";
                clearInterval(check);
            }
        }, 100);
    };
    document.body.appendChild(script);
};
loadCV();

const canvas = document.getElementById('canvasMain');
const ctx = canvas.getContext('2d');

document.getElementById('fileInput').onchange = (e) => {
    if (e.target.files.length === 0) return;
    const reader = new FileReader();
    reader.onload = (f) => {
        const img = new Image();
        img.onload = () => {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            if (srcMat) srcMat.delete();
            srcMat = cv.imread(canvas);
            resetPoints();
        };
        img.src = f.target.result;
    };
    reader.readAsDataURL(e.target.files[0]);
};

canvas.onclick = (e) => {
    if (!srcMat) return;
    const rect = canvas.getBoundingClientRect();
    const x = (e.clientX - rect.left) * (canvas.width / rect.width);
    const y = (e.clientY - rect.top) * (canvas.height / rect.height);
    if (points.length < 6) {
        points.push({x, y});
        processImage();
    }
};

function resetPoints() {
    points = [];
    document.getElementById('totalCount').innerText = "0";
    if(srcMat) cv.imshow('canvasMain', srcMat);
}

function processImage() {
    if (!srcMat) return;
    
    let displayMat = srcMat.clone();
    let gray = new cv.Mat();
    cv.cvtColor(srcMat, gray, cv.COLOR_RGBA2GRAY);

    const r = parseInt(document.getElementById('radiusRange').value);
    const t_val = parseInt(document.getElementById('threshold').value);
    const a_val = parseInt(document.getElementById('minArea').value);
    
    document.getElementById('v_radius').innerText = r;
    document.getElementById('v_thresh').innerText = t_val;
    document.getElementById('v_area').innerText = a_val;

    // 1. åˆ›å»ºå­”ä½æ©æ¨¡
    let mask = cv.Mat.zeros(srcMat.rows, srcMat.cols, cv.CV_8U);
    points.forEach(p => {
        cv.circle(mask, new cv.Point(p.x, p.y), r, [255, 255, 255, 255], -1);
        cv.circle(displayMat, new cv.Point(p.x, p.y), r, [255, 0, 0, 255], 3);
    });

    // 2. å±€éƒ¨åº”ç”¨æ©æ¨¡
    let maskedGray = new cv.Mat();
    gray.copyTo(maskedGray, mask);

    // 3. æ ¸å¿ƒè¯†åˆ«ç®—æ³•
    let thresh = new cv.Mat();
    // æ ¹æ®æ¨¡å¼å†³å®šæ˜¯æ­£å‘è¿˜æ˜¯åå‘é˜ˆå€¼
    let type = isDarkColony ? cv.THRESH_BINARY_INV : cv.THRESH_BINARY;
    cv.threshold(maskedGray, thresh, t_val, 255, type);

    // 4. å½¢æ€å­¦å¢å¼º (å»æ‰æå°å™ªç‚¹)
    let M = cv.Mat.ones(3, 3, cv.CV_8U);
    cv.morphologyEx(thresh, thresh, cv.MORPH_OPEN, M);

    // 5. è½®å»“æ£€æµ‹
    let contours = new cv.MatVector();
    let hierarchy = new cv.Mat();
    cv.findContours(thresh, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

    let count = 0;
    for (let i = 0; i < contours.size(); ++i) {
        let cnt = contours.get(i);
        let area = cv.contourArea(cnt);
        if (area > a_val) {
            count++;
            // åœ¨åŸå›¾ç»˜åˆ¶ç»¿è‰²è¾¹ç¼˜
            cv.drawContours(displayMat, contours, i, [0, 255, 0, 255], 2);
        }
    }

    cv.imshow('canvasMain', displayMat);
    document.getElementById('totalCount').innerText = count;

    // æ¸…ç†æ˜¾å­˜
    gray.delete(); mask.delete(); maskedGray.delete(); 
    thresh.delete(); M.delete(); contours.delete(); hierarchy.delete(); displayMat.delete();
}

document.querySelectorAll('input[type=range]').forEach(el => el.oninput = processImage);
</script>
</body>
</html>
