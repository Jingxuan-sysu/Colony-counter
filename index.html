<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>6å­”æ¿å…‹éš†è®¡æ•°å™¨ - æœ€ç»ˆä¼˜åŒ–ç‰ˆ</title>
    <style>
        :root { --accent: #27ae60; --primary: #2c3e50; }
        body { font-family: system-ui, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .main-layout { display: grid; grid-template-columns: 320px 1fr; gap: 20px; }
        .sidebar { background: #fff; padding: 20px; border-radius: 10px; border: 1px solid #ddd; }
        .canvas-container { background: #333; border-radius: 8px; overflow: hidden; position: relative; min-height: 500px; }
        canvas { display: block; max-width: 100%; height: auto; margin: 0 auto; cursor: crosshair; }
        .stats { background: var(--primary); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px; }
        .btn { width: 100%; padding: 12px; margin-bottom: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-blue { background: #3498db; color: white; }
        .btn-orange { background: #e67e22; color: white; }
        .loading-mask { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); display: flex; align-items: center; justify-content: center; z-index: 1000; flex-direction: column; }
        .label-group { margin: 15px 0 5px; font-size: 0.9em; font-weight: bold; display: flex; justify-content: space-between; }
        input[type="range"] { width: 100%; }
    </style>
</head>
<body>

<div id="loader" class="loading-mask">
    <div style="font-size: 1.5rem; margin-bottom: 10px;">ğŸ§ª æ­£åœ¨å¯åŠ¨å®éªŒç®—æ³•åº“...</div>
    <div id="load-status">æ­£åœ¨è¿æ¥é«˜é€ŸèŠ‚ç‚¹ (unpkg)...</div>
</div>

<div class="container">
    <div class="main-layout">
        <div class="sidebar">
            <div class="stats">
                <small>å…‹éš†è®¡æ•°ç»“æœ</small>
                <div style="font-size: 3rem;" id="totalCount">0</div>
            </div>
            
            <input type="file" id="fileInput" accept="image/*" style="display:none">
            <button class="btn btn-blue" onclick="document.getElementById('fileInput').click()">1. ä¸Šä¼ å›¾ç‰‡</button>
            <button class="btn" onclick="resetPoints()">é‡é€‰åœ†å¿ƒ</button>
            
            <hr>
            <div class="label-group"><span>åº•è‰²æ¨¡å¼:</span></div>
            <button class="btn btn-orange" id="modeBtn" onclick="toggleMode()">æµ…è‰²èƒŒæ™¯-æ·±è‰²é›†è½</button>

            <div class="label-group"><span>è¯†åˆ«çµæ•åº¦:</span><span id="v_thresh">127</span></div>
            <input type="range" id="threshold" min="0" max="255" value="127">

            <div class="label-group"><span>å­”å¾„åŠå¾„:</span><span id="v_radius">200</span></div>
            <input type="range" id="radiusRange" min="50" max="1500" value="200">

            <div class="label-group"><span>æœ€å°é›†è½é¢ç§¯:</span><span id="v_area">15</span></div>
            <input type="range" id="minArea" min="1" max="500" value="15">

            <div style="margin-top:20px; font-size: 0.8em; color: #666; border-top: 1px solid #eee; pt: 10px;">
                <b>è¯†åˆ«ä¸åˆ°ï¼Ÿå°è¯•ï¼š</b><br>
                1. åˆ‡æ¢åº•è‰²æ¨¡å¼<br>
                2. å·¦å³å¤§å¹…æ»‘åŠ¨â€œçµæ•åº¦â€<br>
                3. ç¡®è®¤çº¢åœˆå·²åŒ…å›´å­”å†…åŒºåŸŸ
            </div>
        </div>

        <div class="canvas-container">
            <canvas id="canvasMain"></canvas>
        </div>
    </div>
</div>

<script>
// ä½¿ç”¨æ›´ç¨³å®šçš„ CDN
const CV_URL = 'https://unpkg.com/opencv.js-pure@4.3.0/opencv.js';

let srcMat = null;
let points = [];
let isDarkColony = true;

// è„šæœ¬åŠ è½½é€»è¾‘
const script = document.createElement('script');
script.src = CV_URL;
script.async = true;
script.onload = () => {
    let check = setInterval(() => {
        if (window.cv && cv.Mat) {
            document.getElementById('loader').style.display = 'none';
            clearInterval(check);
        }
    }, 200);
};
document.body.appendChild(script);

const canvas = document.getElementById('canvasMain');
const ctx = canvas.getContext('2d');

document.getElementById('fileInput').onchange = (e) => {
    if (!e.target.files[0]) return;
    const img = new Image();
    img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        if (srcMat) srcMat.delete();
        srcMat = cv.imread(canvas);
        resetPoints();
    };
    img.src = URL.createObjectURL(e.target.files[0]);
};

canvas.onclick = (e) => {
    if (!srcMat) return;
    const rect = canvas.getBoundingClientRect();
    const x = (e.clientX - rect.left) * (canvas.width / rect.width);
    const y = (e.clientY - rect.top) * (canvas.height / rect.height);
    if (points.length < 6) {
        points.push({x, y});
        processImage();
    }
};

function toggleMode() {
    isDarkColony = !isDarkColony;
    document.getElementById('modeBtn').innerText = isDarkColony ? "æµ…è‰²èƒŒæ™¯-æ·±è‰²é›†è½" : "æ·±è‰²èƒŒæ™¯-æµ…è‰²é›†è½";
    processImage();
}

function resetPoints() {
    points = [];
    if(srcMat) cv.imshow('canvasMain', srcMat);
    document.getElementById('totalCount').innerText = "0";
}

function processImage() {
    if (!srcMat) return;
    
    let displayMat = srcMat.clone();
    let gray = new cv.Mat();
    cv.cvtColor(srcMat, gray, cv.COLOR_RGBA2GRAY);

    // --- æ–°å¢ï¼šè‡ªåŠ¨å¯¹æ¯”åº¦å¢å¼º (CLAHE) ---
    // è¿™ä¸€æ­¥èƒ½æ˜¾è‘—æå‡æ¨¡ç³Šé›†è½çš„è¯†åˆ«ç‡
    let clahe = new cv.CLAHE(2.0, new cv.Size(8, 8));
    clahe.apply(gray, gray);
    clahe.delete();

    const r = parseInt(document.getElementById('radiusRange').value);
    const t_val = parseInt(document.getElementById('threshold').value);
    const a_val = parseInt(document.getElementById('minArea').value);
    
    document.getElementById('v_radius').innerText = r;
    document.getElementById('v_thresh').innerText = t_val;
    document.getElementById('v_area').innerText = a_val;

    let mask = cv.Mat.zeros(srcMat.rows, srcMat.cols, cv.CV_8U);
    points.forEach(p => {
        cv.circle(mask, new cv.Point(p.x, p.y), r, [255, 255, 255, 255], -1);
        cv.circle(displayMat, new cv.Point(p.x, p.y), r, [255, 0, 0, 255], 4);
    });

    let maskedGray = new cv.Mat();
    gray.copyTo(maskedGray, mask);

    let thresh = new cv.Mat();
    let type = isDarkColony ? cv.THRESH_BINARY_INV : cv.THRESH_BINARY;
    cv.threshold(maskedGray, thresh, t_val, 255, type);

    let M = cv.Mat.ones(3, 3, cv.CV_8U);
    cv.morphologyEx(thresh, thresh, cv.MORPH_OPEN, M);

    let contours = new cv.MatVector();
    let hierarchy = new cv.Mat();
    cv.findContours(thresh, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

    let count = 0;
    for (let i = 0; i < contours.size(); ++i) {
        let cnt = contours.get(i);
        if (cv.contourArea(cnt) > a_val) {
            count++;
            cv.drawContours(displayMat, contours, i, [0, 255, 0, 255], 2);
        }
    }

    cv.imshow('canvasMain', displayMat);
    document.getElementById('totalCount').innerText = count;

    gray.delete(); mask.delete(); maskedGray.delete(); thresh.delete(); 
    M.delete(); contours.delete(); hierarchy.delete(); displayMat.delete();
}

document.querySelectorAll('input[type=range]').forEach(el => el.oninput = processImage);
</script>
</body>
</html>
