<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>6å­”æ¿å…‹éš†è®¡æ•° - æ‰‹åŠ¨å®šå­”ç‰ˆ</title>
    <script async src="https://docs.opencv.org/4.5.4/opencv.js" type="text/javascript"></script>
    <style>
        :root { --accent: #e74c3c; --primary: #2c3e50; }
        body { font-family: -apple-system, sans-serif; background: #fdfdfd; padding: 20px; color: var(--primary); }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 25px rgba(0,0,0,0.05); }
        .steps-bar { background: #ebf5ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #3498db; }
        .main-layout { display: grid; grid-template-columns: 300px 1fr; gap: 30px; }
        .canvas-wrapper { position: relative; border: 1px solid #ccc; cursor: crosshair; overflow: hidden; }
        canvas { display: block; max-width: 100%; height: auto; }
        .controls { background: #f8f9fa; padding: 20px; border-radius: 10px; }
        .btn { width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-reset { background: #95a5a6; color: white; }
        .btn-run { background: #27ae60; color: white; }
        .label { font-weight: bold; font-size: 0.9em; display: block; margin: 15px 0 5px; }
        .point-hint { color: var(--accent); font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ§« ç»†èƒå…‹éš†è®¡æ•° (æ‰‹åŠ¨å®šå­”äº¤äº’ç‰ˆ)</h2>
    
    <div class="steps-bar" id="instruction">
        <strong>æ“ä½œæŒ‡å—ï¼š</strong> 1. ä¸Šä¼ å›¾ç‰‡ -> 2. åœ¨å³å›¾<b>ä¾æ¬¡ç‚¹å‡»</b> 6 ä¸ªå­”çš„ä¸­å¿ƒç‚¹ -> 3. è°ƒæ•´å³ä¾§æ»‘å—è·å–ç»“æœã€‚
    </div>

    <div class="main-layout">
        <div class="sidebar">
            <input type="file" id="fileInput" accept="image/*" style="display:none">
            <button class="btn btn-reset" onclick="document.getElementById('fileInput').click()">1. ä¸Šä¼ æ–°å›¾ç‰‡</button>
            <button class="btn btn-reset" style="background:#e67e22" onclick="resetPoints()">é‡é€‰åœ†å¿ƒç‚¹</button>

            <hr>
            <span class="label">å·²é€‰åœ†å¿ƒæ•°: <span id="pointCount" class="point-hint">0 / 6</span></span>
            
            <span class="label">å­”å¾„å¤§å° (åŠå¾„): <span id="v_radius">100</span></span>
            <input type="range" id="radiusRange" min="50" max="1000" value="200">

            <span class="label">è¯†åˆ«çµæ•åº¦: <span id="v_thresh">120</span></span>
            <input type="range" id="threshold" min="0" max="255" value="120">

            <span class="label">æœ€å°å…‹éš†é¢ç§¯: <span id="v_area">30</span></span>
            <input type="range" id="minArea" min="5" max="500" value="30">

            <div style="margin-top:20px; padding:15px; background:#2c3e50; color:white; border-radius:8px; text-align:center;">
                <small>å½“å‰å­”å†…æ€»è®¡</small>
                <div style="font-size:2.5rem;" id="totalCount">0</div>
            </div>
        </div>

        <div class="display-area">
            <div class="canvas-wrapper" id="canvasWrapper">
                <canvas id="canvasMain"></canvas>
            </div>
            <p style="font-size:0.8rem; color:#888;">* ç‚¹å‡»ä¸Šæ–¹å›¾ç‰‡å³å¯æ ‡è®°åœ†å¿ƒï¼Œç³»ç»Ÿå°†è‡ªåŠ¨å±è”½åœ†åœˆå¤–çš„è¾¹æ¡†å¹²æ‰°ã€‚</p>
        </div>
    </div>
</div>

<script>
let srcMat = null;
let points = [];
const canvas = document.getElementById('canvasMain');

// 1. åˆå§‹åŒ–
function onOpenCvReady() {
    document.getElementById('instruction').innerHTML = "âœ… ç®—æ³•åº“å·²å°±ç»ªï¼è¯·ä¸Šä¼  6 å­”æ¿å›¾ç‰‡ã€‚";
}

document.getElementById('fileInput').onchange = (e) => {
    if (e.target.files.length === 0) return;
    const reader = new FileReader();
    reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            if (srcMat) srcMat.delete();
            srcMat = cv.imread(canvas);
            resetPoints();
        };
        img.src = event.target.result;
    };
    reader.readAsDataURL(e.target.files[0]);
};

// 2. ç‚¹å‡»äº¤äº’
canvas.onclick = (e) => {
    if (!srcMat) return;
    
    // è®¡ç®—ç›¸å¯¹äºå›¾ç‰‡çš„å®é™…åæ ‡
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const x = (e.clientX - rect.left) * scaleX;
    const y = (e.clientY - rect.top) * scaleY;

    if (points.length < 6) {
        points.push({x, y});
        document.getElementById('pointCount').innerText = `${points.length} / 6`;
        processImage();
    }
};

function resetPoints() {
    points = [];
    document.getElementById('pointCount').innerText = "0 / 6";
    if(srcMat) cv.imshow('canvasMain', srcMat);
}

// 3. æ ¸å¿ƒç®—æ³•é€»è¾‘
function processImage() {
    if (!srcMat) return;

    let displayMat = srcMat.clone();
    let gray = new cv.Mat();
    cv.cvtColor(srcMat, gray, cv.COLOR_RGBA2GRAY);

    // è·å–å‚æ•°
    const r = parseInt(document.getElementById('radiusRange').value);
    const t_val = parseInt(document.getElementById('threshold').value);
    const a_val = parseInt(document.getElementById('minArea').value);
    document.getElementById('v_radius').innerText = r;
    document.getElementById('v_thresh').innerText = t_val;
    document.getElementById('v_area').innerText = a_val;

    // åˆ›å»ºæ©æ¨¡ (Mask) å±è”½è¾¹æ¡†
    let mask = cv.Mat.zeros(srcMat.rows, srcMat.cols, cv.CV_8U);
    points.forEach(p => {
        // åœ¨æ©æ¨¡ä¸Šç”»ç™½åœ†
        cv.circle(mask, new cv.Point(p.x, p.y), r, [255, 255, 255, 255], -1);
        // åœ¨æ˜¾ç¤ºå›¾ä¸Šç”»çº¢åœˆæ ‡è®°èŒƒå›´
        cv.circle(displayMat, new cv.Point(p.x, p.y), r, [255, 0, 0, 255], 5);
    });

    // ä»…åˆ†ææ©æ¨¡åŒº
    let maskedGray = new cv.Mat();
    gray.copyTo(maskedGray, mask);

    let thresh = new cv.Mat();
    cv.threshold(maskedGray, thresh, t_val, 255, cv.THRESH_BINARY_INV);
    
    let M = cv.Mat.ones(3, 3, cv.CV_8U);
    cv.morphologyEx(thresh, thresh, cv.MORPH_OPEN, M);

    let contours = new cv.MatVector();
    let hierarchy = new cv.Mat();
    cv.findContours(thresh, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

    let count = 0;
    for (let i = 0; i < contours.size(); ++i) {
        let cnt = contours.get(i);
        if (cv.contourArea(cnt) > a_val) {
            count++;
            cv.drawContours(displayMat, contours, i, [0, 255, 0, 255], 3);
        }
    }

    cv.imshow('canvasMain', displayMat);
    document.getElementById('totalCount').innerText = count;

    // é‡Šæ”¾å†…å­˜
    gray.delete(); mask.delete(); maskedGray.delete(); thresh.delete(); 
    M.delete(); contours.delete(); hierarchy.delete(); displayMat.delete();
}

// ç»‘å®šæ»‘å—
document.querySelectorAll('input[type=range]').forEach(el => el.oninput = processImage);

var Module = { onRuntimeInitialized: onOpenCvReady };
</script>

</body>
</html>
